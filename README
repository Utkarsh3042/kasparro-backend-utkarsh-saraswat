# Crypto ETL Backend System

A production-ready ETL (Extract, Transform, Load) backend system for cryptocurrency data ingestion from **CoinGecko** and **CoinPaprika** APIs. Built with FastAPI, featuring robust error handling, retry mechanisms, comprehensive logging, and clean architecture principles.

**Assignment Submission for Kasparov Backend & ETL Systems**

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API Gateway Layer                        â”‚
â”‚                  (FastAPI with CORS)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Ingestion  â”‚   â”‚   Business   â”‚   â”‚   Monitoring â”‚
â”‚     Layer    â”‚   â”‚     Logic    â”‚   â”‚    Layer     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Data Storage Layer                       â”‚
â”‚         (In-Memory / Extensible to DB)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           External Data Sources                       â”‚
â”‚   CoinGecko API  â”‚  CoinPaprika API                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Features

### **P0 - Foundation Layer** âœ…
- âœ… **Dual Data Source Ingestion**: CoinGecko + CoinPaprika APIs
- âœ… **RESTful API**: FastAPI with automatic OpenAPI documentation
- âœ… **Health Monitoring**: `/health` endpoint for service status
- âœ… **Dockerized Deployment**: One-command setup with Docker Compose
- âœ… **Test Suite**: Unit and integration tests

### **P1 - Growth Layer** âœ…
- âœ… **Statistical Analysis** (`/stats`): Market metrics, top gainers/losers
- âœ… **Advanced Filtering**: Filter by source, symbol, pagination
- âœ… **Clean Architecture**: Separation of concerns (data, business, API layers)
- âœ… **Comprehensive Error Handling**: Retry logic, timeout handling

### **P2 - Differentiation Layer** âœ…
- âœ… **Rate Limiting & Backoff**: Exponential backoff for API failures
- âœ… **Observability**: Structured logging with timestamps
- âœ… **Failure Recovery**: Graceful degradation on API failures
- âœ… **Configuration Management**: Environment-based settings

## ğŸ“ Project Structure

```
backend-etl-system/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                    # FastAPI application entry point
â”‚   â”œâ”€â”€ config.py                  # Configuration management
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ routes.py              # API endpoint definitions
â”‚   â”œâ”€â”€ ingestion/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                # Base ingestion class
â”‚   â”‚   â”œâ”€â”€ coingecko.py           # CoinGecko API integration
â”‚   â”‚   â””â”€â”€ coinpaprika.py         # CoinPaprika API integration
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ schemas.py             # Pydantic data models
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ storage.py             # Data storage abstraction
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ logger.py              # Logging configuration
â”‚       â””â”€â”€ retry.py               # Retry logic utilities
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_api.py                # API endpoint tests
â”‚   â”œâ”€â”€ test_ingestion.py          # Data ingestion tests
â”‚   â””â”€â”€ test_utils.py              # Utility function tests
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ API.md                     # API documentation
â”‚   â””â”€â”€ DEPLOYMENT.md              # Deployment guide
â”œâ”€â”€ .env.example                   # Environment template
â”œâ”€â”€ .gitignore
â”œâ”€â”€ Dockerfile                     # Container image definition
â”œâ”€â”€ docker-compose.yml             # Multi-container orchestration
â”œâ”€â”€ requirements.txt               # Python dependencies
â”œâ”€â”€ pytest.ini                     # Test configuration
â””â”€â”€ README.md                      # This file
```

## ğŸ› ï¸ Technology Stack

- **Backend Framework**: FastAPI 0.104+
- **Data Processing**: Pandas 2.1+
- **HTTP Client**: Requests with retry logic
- **Validation**: Pydantic v2
- **Testing**: Pytest
- **Containerization**: Docker & Docker Compose
- **Python**: 3.11+

## âš¡ Quick Start

### **Prerequisites**
- Python 3.10+ installed
- Docker & Docker Compose installed (optional)
- CoinPaprika API key ([Get one here](https://coinpaprika.com/api))
- Git (for version control)

### **1. Clone or Download Repository**
```bash
git clone <repository-url>
cd backend-etl-system
```

### **2. Configure Environment**

**Windows (PowerShell):**
```powershell
Copy-Item .env.example .env
# Edit .env in VS Code or Notepad and add your COINPAPRIKA_API_KEY
```

**Linux/Mac:**
```bash
cp .env.example .env
# Edit .env and add your COINPAPRIKA_API_KEY
```

**Update `.env` file:**
```env
COINPAPRIKA_API_KEY=your_actual_api_key_here
COINPAPRIKA_API_URL=https://api.coinpaprika.com/v1
COINGECKO_API_URL=https://api.coingecko.com/api/v3
LOG_LEVEL=INFO
```

### **3. Run with Docker** (Recommended)
```bash
docker-compose up --build
```

### **4. Or Run Locally (Without Docker)**

**Windows (PowerShell):**
```powershell
# Create virtual environment
python -m venv venv

# Activate virtual environment
venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Install package in development mode
pip install -e .

# Run the application
uvicorn src.main:app --reload
```

**Linux/Mac:**
```bash
# Create and activate virtual environment
python -m venv venv
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt
pip install -e .

# Run the application
uvicorn src.main:app --reload
```

### **5. Access Services**
- **API Base URL**: http://localhost:8000
- **Interactive API Docs**: http://localhost:8000/docs â­ (Recommended for testing)
- **Alternative Docs**: http://localhost:8000/redoc
- **Health Check**: http://localhost:8000/health

## ğŸ“– API Usage

### **ğŸŒŸ Recommended: Use Interactive API Docs**

Open your browser and navigate to **http://localhost:8000/docs**

This provides an interactive interface where you can:
- View all available endpoints
- Test endpoints with "Try it out" button
- See request/response schemas
- No command-line needed!

---

### **Command Line Usage**

#### **Windows (PowerShell)**

**1. Ingest Data from CoinGecko**
```powershell
Invoke-WebRequest -Uri "http://localhost:8000/api/v1/ingest/coingecko?limit=100" -Method POST -UseBasicParsing | Select-Object -Expand Content
```

**2. Ingest Data from CoinPaprika**
```powershell
Invoke-WebRequest -Uri "http://localhost:8000/api/v1/ingest/coinpaprika?limit=50" -Method POST -UseBasicParsing | Select-Object -Expand Content
```

**3. Ingest from Both Sources**
```powershell
Invoke-WebRequest -Uri "http://localhost:8000/api/v1/ingest/all" -Method POST -UseBasicParsing | Select-Object -Expand Content
```

**4. Retrieve Data with Filtering**
```powershell
# Get paginated data
Invoke-WebRequest -Uri "http://localhost:8000/api/v1/data?page=1&page_size=20" -UseBasicParsing | Select-Object -Expand Content

# Filter by source
Invoke-WebRequest -Uri "http://localhost:8000/api/v1/data?source=coingecko" -UseBasicParsing | Select-Object -Expand Content

# Filter by symbol
Invoke-WebRequest -Uri "http://localhost:8000/api/v1/data?symbol=BTC" -UseBasicParsing | Select-Object -Expand Content
```

**5. Get Market Statistics**
```powershell
Invoke-WebRequest -Uri "http://localhost:8000/api/v1/stats" -UseBasicParsing | Select-Object -Expand Content
```

#### **Linux/Mac/Git Bash**

**1. Ingest Data from CoinGecko**
```bash
curl -X POST "http://localhost:8000/api/v1/ingest/coingecko?limit=100"
```

**2. Ingest Data from CoinPaprika**
```bash
curl -X POST "http://localhost:8000/api/v1/ingest/coinpaprika?limit=50"
```

**3. Ingest from Both Sources**
```bash
curl -X POST "http://localhost:8000/api/v1/ingest/all"
```

**4. Retrieve Data with Filtering**
```bash
# Get paginated data
curl "http://localhost:8000/api/v1/data?page=1&page_size=20"

# Filter by source
curl "http://localhost:8000/api/v1/data?source=coingecko"

# Filter by symbol
curl "http://localhost:8000/api/v1/data?symbol=BTC"
```

**5. Get Market Statistics**
```bash
curl "http://localhost:8000/api/v1/stats"
```

**Response Example:**
```json
{
  "total_coins": 150,
  "total_market_cap": 2500000000000,
  "total_volume": 150000000000,
  "avg_price": 1250.50,
  "top_gainers": [...],
  "top_losers": [...]
}
```

## ğŸ§ª Testing

### **Prerequisites**
```powershell
# Ensure you're in the project root and virtual environment is activated
cd C:\Users\bossu\OneDrive\Desktop\assignment\backend-etl-system
venv\Scripts\activate

# Install in development mode (first time only)
pip install -e .
```

### **Run All Tests**
```powershell
# With Docker
docker-compose run backend pytest

# Locally (Windows)
pytest -v

# Or using Python module
python -m pytest -v
```

### **Run with Coverage**
```powershell
# Install coverage tool
pip install pytest-cov

# Run tests with coverage
pytest --cov=src --cov-report=term-missing

# Generate HTML coverage report
pytest --cov=src --cov-report=html

# Open coverage report in browser
start htmlcov\index.html
```

### **Run Specific Tests**
```powershell
# Test specific file
pytest tests\test_api.py -v

# Test specific function
pytest tests\test_api.py::test_health_check -v

# Run with more verbosity
pytest -vv

# Stop at first failure
pytest -x
```

## ğŸ”§ Development Setup

### **Local Development (Without Docker)**

#### **Windows (PowerShell)**

1. **Create Virtual Environment**
```powershell
python -m venv venv
```

2. **Activate Virtual Environment**
```powershell
venv\Scripts\activate
# You should see (venv) in your terminal prompt
```

3. **Install Dependencies**
```powershell
pip install -r requirements.txt
pip install -e .  # Install in development mode
```

4. **Configure Environment**
```powershell
# Copy template
Copy-Item .env.example .env

# Edit .env file and add your API key
code .env  # Opens in VS Code
# Or: notepad .env
```

5. **Run Development Server**
```powershell
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

#### **Linux/Mac**

1. **Create and Activate Virtual Environment**
```bash
python -m venv venv
source venv/bin/activate
```

2. **Install Dependencies**
```bash
pip install -r requirements.txt
pip install -e .
```

3. **Set Environment Variables**
```bash
cp .env.example .env
# Edit .env and add your COINPAPRIKA_API_KEY
```

4. **Run Development Server**
```bash
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

### **Development Workflow**

1. **Start the server** (with hot reload)
2. **Open API docs** at http://localhost:8000/docs
3. **Make code changes** - server will auto-reload
4. **Run tests** after changes: `pytest -v`
5. **Check logs** in the terminal for debugging

## ğŸš¢ Deployment

### **Docker Hub Deployment**

1. **Build Image**
```bash
docker build -t yourusername/crypto-etl-backend:latest .
```

2. **Push to Registry**
```bash
docker push yourusername/crypto-etl-backend:latest
```

3. **Pull and Run**
```bash
docker pull yourusername/crypto-etl-backend:latest
docker run -p 8000:8000 --env-file .env yourusername/crypto-etl-backend:latest
```

### **Cloud Deployment**

See [DEPLOYMENT.md](docs/DEPLOYMENT.md) for:
- AWS ECS deployment
- Google Cloud Run deployment
- Azure Container Instances deployment

## ğŸ” Security

- âœ… API keys stored in environment variables
- âœ… No sensitive data in version control
- âœ… CORS middleware configured
- âœ… Input validation with Pydantic
- âœ… Rate limiting on external API calls

## ğŸ“Š Monitoring & Observability

### **Health Check**
```bash
curl http://localhost:8000/health
```

**Response:**
```json
{
  "status": "healthy",
  "message": "Crypto ETL Backend is running",
  "version": "1.0.0",
  "timestamp": "2024-12-25T10:30:00Z"
}
```

### **Logging**
All operations are logged with:
- Timestamp
- Log level
- Component name
- Error details (if applicable)

Example:
```
2024-12-25 10:30:15 - INFO - CoinGecko: Fetched 100 coins successfully
2024-12-25 10:30:20 - ERROR - CoinPaprika: API request failed, retrying...
```

## ğŸ›¡ï¸ Error Handling

The system implements robust error handling:

1. **Network Failures**: Automatic retry with exponential backoff
2. **API Rate Limits**: Graceful backoff and retry
3. **Invalid Data**: Validation errors logged, processing continues
4. **Timeouts**: Configurable timeout with fallback
5. **Partial Failures**: One source failure doesn't block others

## ğŸ”„ Future Enhancements

- [ ] PostgreSQL integration for persistent storage
- [ ] Redis caching layer
- [ ] WebSocket support for real-time updates
- [ ] Incremental data ingestion with change detection
- [ ] GraphQL API layer
- [ ] Prometheus metrics export
- [ ] Kubernetes deployment manifests

## ğŸ“ Configuration

### **Environment Variables**

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `COINPAPRIKA_API_KEY` | Yes | - | CoinPaprika API key |
| `COINGECKO_API_URL` | No | `https://api.coingecko.com/api/v3` | CoinGecko base URL |
| `COINPAPRIKA_API_URL` | No | `https://api.coinpaprika.com/v1` | CoinPaprika base URL |
| `LOG_LEVEL` | No | `INFO` | Logging level |

## ğŸ” Troubleshooting

### **Common Issues**

#### **1. Module Not Found Error**
```
ModuleNotFoundError: No module named 'src'
```
**Solution:**
```powershell
# Make sure you're in the project root
cd C:\Users\bossu\OneDrive\Desktop\assignment\backend-etl-system

# Install in development mode
pip install -e .

# Run tests
pytest
```

#### **2. PowerShell curl Command Not Working**
```
Invoke-WebRequest : A parameter cannot be found that matches parameter name 'X'.
```
**Solution:** Use `Invoke-WebRequest` instead of `curl`, or use the interactive docs at http://localhost:8000/docs

#### **3. API Key Error**
```
ValidationError: COINPAPRIKA_API_KEY
```
**Solution:**
- Open `.env` file
- Replace `paste_your_actual_api_key_here` with your actual API key from coinpaprika.com
- Restart the application

#### **4. Port Already in Use**
```
Error: [Errno 10048] error while attempting to bind on address ('0.0.0.0', 8000)
```
**Solution:**
```powershell
# Find process using port 8000
netstat -ano | findstr :8000

# Kill the process (replace PID with actual process ID)
taskkill /PID <PID> /F

# Or use a different port
uvicorn src.main:app --reload --port 8001
```

#### **5. Virtual Environment Not Activating**
**Solution:**
```powershell
# Enable script execution (run as Administrator)
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# Then activate
venv\Scripts\activate
```

### **Getting Help**

1. Check the logs in the terminal
2. Review API documentation at http://localhost:8000/docs
3. Verify environment variables in `.env` file
4. Ensure all dependencies are installed: `pip list`
5. Check Python version: `python --version` (should be 3.10+)

## ğŸ¤ Contributing

1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

## ğŸ“„ License

This project is licensed under the MIT License.

## ğŸ‘¥ Author

- **Student Submission** - Backend & ETL Systems Assignment
- **Institution**: Kasparov
- **Date**: December 25, 2025

## ğŸ™ Acknowledgments

- **CoinGecko API** - Free cryptocurrency market data
- **CoinPaprika API** - Comprehensive crypto information
- **FastAPI** - Modern, fast web framework for building APIs
- **Kasparov** - Assignment specification and guidance

---

## ğŸ“ Support

- **API Documentation**: http://localhost:8000/docs
- **Health Check**: http://localhost:8000/health
- **Project Repository**: [GitHub Link]

---

**Assignment Completion Checklist:**
- âœ… P0: Dual data sources (CoinGecko + CoinPaprika)
- âœ… P0: RESTful API with `/data` and `/health` endpoints
- âœ… P0: Dockerized deployment
- âœ… P0: Test suite
- âœ… P1: `/stats` endpoint with analytics
- âœ… P1: Clean architecture with separated concerns
- âœ… P2: Retry logic with exponential backoff
- âœ… P2: Comprehensive logging and observability
- âœ… P2: Robust error handling and recovery